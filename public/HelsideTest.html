<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width" />
<title>Insert title here</title>

<!--jQuery References-->
<script src="http://code.jquery.com/jquery-1.8.2.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js" type="text/javascript"></script>
<!--  
<script src="http://code.jquery.com/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/ui/1.10.1/jquery-ui.min.js" type="text/javascript"></script>
-->
  

<!--Wijmo Widgets CSS-->
<link href="http://cdn.wijmo.com/jquery.wijmo-pro.all.3.20131.3.min.css" rel="stylesheet" type="text/css" />
  
<!--Theme-->
<link href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" rel="stylesheet" type="text/css" />
    
<!--Wijmo Widgets JavaScript-->
<script src="http://cdn.wijmo.com/jquery.wijmo-open.all.3.20131.3.min.js" type="text/javascript"></script>
<script src="http://cdn.wijmo.com/jquery.wijmo-pro.all.3.20131.3.min.js" type="text/javascript"></script>

<!--Knockout Library-->
<script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.0.js" type="text/javascript"></script>

<!--Wijmo Knockout Integration Library-->
<script src="http://cdn.wijmo.com/interop/knockout.wijmo.3.20131.3.js" type="text/javascript"></script>

<script src="http://cdn.wijmo.com/wijmo/wijmo.data.ajax.js" type="text/javascript"></script>




</head>
<body>



<script id="chartscript" type="text/javascript">
      //  $.support.cors = true;
    // var employees = $.get("http://localhost:3000/data2");
function makeArrayOf(value, length) {
  var arr = [], i = length;
  while (i--) {
    arr[i] = value;
  }
  return arr;
}

$.get("http://localhost:3000/data2",
       function(data) {

var fullList = [];
var nameUsage = [];
var barNameList = [];
var usageList = [];
var barChartList = {};
var barServiceList = [];
var serviceFlag = 0;
for (var i = 0, len = data.length; i < len; i++) {
    var result = data[i];
    fullList.push({ name: result.name, service: result.service, policy: result.policy, usage: result.usage });
    nameUsage.push({ name: result.name, usage: result.usage });
    usageList.push(result.usage);

    if (barServiceList.indexOf(result.service) == -1) //NEW SERVICE
     {
       if (barNameList.indexOf(result.name) == -1) //NEW SERVICE, NEW NAME
        {  
            barServiceList.push(result.service);
            barNameList.push(result.name);
            barChartList[result.service] = {};
            barChartList[result.service].label = result.service;
            barChartList[result.service].legendEntry = true;
            barChartList[result.service].data = {y : []};
            barChartList[result.service].data.y = makeArrayOf(0, barNameList.length -1);
            

            var x=0;
            var txt="";
            for (x in barChartList)
            {
            barChartList[x].data.y.push(0);
            }
        
            barChartList[result.service].data.y[barNameList.indexOf(result.name)] = result.usage;

        }         
        else //NEW SERVICE, OLD NAME
        {
            barServiceList.push(result.service);
            barChartList[result.service] = {};
            barChartList[result.service].label = result.service;
            barChartList[result.service].legendEntry = true;
            barChartList[result.service].data = {y : []};
            barChartList[result.service].data.y = makeArrayOf(0, barNameList.length);  

            barChartList[result.service].data.y[barNameList.indexOf(result.name)] = result.usage;
          
        }
     }
     else //OLD SERVICE
     {
      if (barNameList.indexOf(result.name) == -1) //OLD SERVICE, NEW NAME        
        { 
            barNameList.push(result.name);

            var x=0;
            var txt="";
            for (x in barChartList)
            {
            barChartList[x].data.y.push(0);
            }
        
            barChartList[result.service].data.y[barNameList.indexOf(result.name)] = result.usage;
        }
        else //OLD SERVICE, OLD NAME
        {
        
            barChartList[result.service].data.y[barNameList.indexOf(result.name)] = result.usage;
 
        }
     }

}// END OF FOR LOOP

var barChartListArray = [];
var barChartNameList = {x : barNameList};
var x=0;
var txt="";
for (x in barChartList)
{
barChartListArray.push(barChartList[x]);
}

$("#barchart1").wijbarchart({
                axis: {
                    y: {
                        text: "Used Data (MB)"
                    },
                    x: {
                        text: ""
                    }
                },
                hint: {
                    content: function () {
                        return this.x + '\n ' + this.y + '';
                    }
                },
                header: {
                    text: "Service usage"
                },
                data : barChartNameList,
                seriesList: barChartListArray,
                seriesStyles: [{
                    fill: "#8ede43", stroke: "#7fc73c", opacity: 0.8
                }],
                seriesHoverStyles: [{ "stroke-width": "1.5", opacity: 1
                }]
            });

}, "json");


</script>




     
<!--
<div id="myResults">hejhej</div>
-->

<div class="container">
    <div class="header">
    </div>
    <div class="main demo">
        <!-- Begin demo markup -->
<!--
      <table id="wijgrid">
     </table>
-->
     <div id="barchart1" class="ui-widget ui-widget-content
       ui-corner-all" style="width: 400px; height: 300px">
</div>

        <table id="demo-grid" data-bind="wijgrid: { data: fullList, allowEditing: false, showFilter: true, columns: [
            { headerText: 'Name', dataKey: 'name' },
            { headerText: 'Service', dataKey: 'service' },
            { headerText: 'Policy', dataKey: 'policy' },
            { headerText: 'Usage', dataKey: 'usage' }
            ]}" >
        </table> 


	
    </div>   
</div>



</body>
</html>